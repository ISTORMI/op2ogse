-- -*- mode: lua; coding: windows-1251-dos -*-
--
-- Удаление трупов и т.п.

function attach( sm )
  sm:subscribe({ signal = "on_before_spawn", fun = this.off_corpses })
end


local tabl_corpses      = {}
local tabl_corpses_9510 = {}
local exceptions_9510   = {
  -- трупики на Кордоне
  [   21 ] = true, -- esc_killer2
  [   24 ] = true, -- esc_factory_prisoner_guard
  [  123 ] = true, -- gar_seryi_drug3
  -- трупики на Свалке
  [  101 ] = true, -- gar_dm_bandit_1
  [  102 ] = true, -- gar_dm_bandit_2
  [  103 ] = true, -- gar_dm_bandit_3
  [  106 ] = true, -- gar_bandit_agr_6
  [  109 ] = true, -- gar_wounded_bandit
  -- трупики в ТД
  [  401 ] = true, -- val_sacrifice_victim
  [  402 ] = true, -- val_prisoner_captive (Лохматый)
  [  404 ] = true, -- val_sacrifice_guard1
  [  405 ] = true, -- val_sacrifice_guard2
  [  406 ] = true, -- Пуля
  [  407 ] = true, -- val_escort_guard1
  [  408 ] = true, -- val_escort_guard2
  [  409 ] = true, -- val_sacrifice_tunnel_bandit
  [  424 ] = true, -- Монгол
  [  518 ] = true, -- Киценко (командир южного блокпоста)
  [  519 ] = true, -- Барин в Баре
  [  571 ] = true, -- Арни
  [  703 ] = true, -- сумашедший на АС
  -- долговцы из группы Черепа и их противники свободовцы
  [  704 ] = true, -- снайпер на Базе Свободы
  [  708 ] = true,
  [  711 ] = true, -- mil_dolg_stalker0006_0000
  [  720 ] = true,
  [  721 ] = true,
  [  722 ] = true,
  [  725 ] = true, -- Угрюмый из кровососовки
  [  730 ] = true, -- снайпер на Базе Свободы
  [  731 ] = true, -- снайпер на Базе Свободы
  [  732 ] = true, -- снайпер на Базе Свободы
  [  736 ] = true,
  [  737 ] = true,
  [  738 ] = true,
  [  740 ] = true,
  -- трупики на хуторе наемников
  [  710 ] = true, -- Павлик
  [  712 ] = true, -- mil_ara_guard3
  [  713 ] = true, -- mil_ara_guard2
  [  714 ] = true, -- mil_ara_guard1
  [  719 ] = true, -- mil_ara
  -- свободовцы в деревне кровососов, у костра
  [  726 ] = true,
  [  727 ] = true,
  -- трупики в Припяти
  [  806 ] = true, -- pri_followers_leader
  [  808 ] = true, -- pri_wave1_monolith1_rsniper1
  [  809 ] = true, -- pri_corner_monolith1
  [  810 ] = true, -- pri_depot_controller1
  [  811 ] = true, -- pri_depot_controller2
  [  812 ] = true, -- pri_depot_controller3
  [  821 ] = true, -- pri_wave4_monolith5_free1
  [  828 ] = true, -- pri_monolith_leader
  -- трупики военных на ЧАЭС-1
  [ 1103 ] = true,
  [ 1104 ] = true,
  [ 1105 ] = true,
  [ 1106 ] = true,
  [ 1107 ] = true,
  [ 1108 ] = true,
  [ 1109 ] = true,
  [ 1110 ] = true,
  -- трупики монолитовцев на Радаре
  [ 1071 ] = true,
  [ 1072 ] = true,
  [ 1073 ] = true,
  [ 1074 ] = true,
  [ 1075 ] = true,
  [ 1109 ] = true, -- какой-то военный на ЧАЭС-1
}

local exceptions_9510_info = {
  [    4 ] = { "esc_shustryi_medusa_done" }, -- Шустрый
  [    5 ] = { "esc_fox_medkit_done" }, -- Лис
  [    7 ] = { "mil_volk_resiver_done" }, -- Толик
  [    9 ] = { "esc_petruha_toz_done" }, -- Петруха
  [   33 ] = { "esc_find_railroad_passage_find_stalker" }, -- труп у аномалии
  [   92 ] = { "esc_find_groza_done" }, -- Проводник
  [  100 ] = { "val_pula_ammo_done", "seriy_helm", }, -- Серый
  -- Юрик
  [  104 ] = {
    "gar_dram_novice_mp5_m1_done",
    "gar_dram_novice_burer_hand_done",
  },
  -- труп на Свалке с МП-5 для Юрика
  [  124 ] = { "gar_dram_novice_mp5_m1_done" },
  [  302 ] = { "agr_krot_PDA_done" }, -- Крот
  [  422 ] = { "val_sos_give_info" }, -- Мессер
  [  437 ] = { "bar_darklab_document_done" }, -- труп с зарядами для РПГ в ТД
  [  450 ] = { "dar_password_info1" }, -- ученый с кодом двери в X-18
  [  451 ] = { "dar_password_info2" }, -- ученый с кодом двери в X-18
  [  724 ] = { "mil_fblockpost_quest_reward" }, -- Кэп
  [  903 ] = { "yan_find_vasilyev_end" }, -- труп Васильева около вертолета
  [  918 ] = { "yan_has_ghost_pda" }, -- труп отмычки Призрака в X-16
  -- военный с лечебным Бериллом на Янтаре
  [  922 ] = { "yan_kill_brain_done" },
  [ 9508 ] = { "bandit_krisyk_umer" }, -- Крысюк

  -- капитан с сумкой Сахарова на ЧАЭС-1
  [ story_ids.aes_soldier_commander ] = { "sahar_sumka_have" },
}

--схема удаления трупов монстров
local tabl_monsters_dead = {} --все мёртвые монстры

--плюс схема удаления бесхозного оружия (если в названии предмета нет
--"grenade_" или "wpn_" - то это не считается оружием и убираться не
--будет !!!)
local tabl_weapons = {}

local always_remove = {
  [ "gl_fake_missile" ] = true,
  [ "gl_fake_missile_ammo_m209"    ] = true,
  [ "gl_fake_missile_ammo_vog-25"  ] = true,
  [ "gl_fake_missile_ammo_vog-25p" ] = true,
  [ "gl_test_shell"   ] = true,
  [ "gl_test_shell_ammo_m209"    ] = true,
  [ "gl_test_shell_ammo_vog-25"  ] = true,
  [ "gl_test_shell_ammo_vog-25p" ] = true,
  [ "grenade_f1_fake"    ] = true,
  [ "grenade_f1_test"    ] = true,
  [ "grenade_flash_fake" ] = true,
  [ "grenade_flash_test" ] = true,
  [ "grenade_rgd5_fake"  ] = true,
  [ "grenade_rgd5_test"  ] = true,
  [ "zone_flame_matches" ] = true,
}


function is_level_vertex_ok( sobj, obj_level )
  local level_vertexes = amk_anoms.level_vertexes[ obj_level ]
  if sobj.m_level_vertex_id >= level_vertexes then
    log2(
      "[%s]: found %s on %s: wrong level_vertex: %s >= %s",
      script_name(), sobj:name(), obj_level,
      sobj.m_level_vertex_id, level_vertexes
    )
    return false
  end
  return true
end


function fix_level_vertex( sobj )
  local vert_ok = level.vertex_id_by_pos(
    sobj.m_level_vertex_id, sobj.position
  )
  if level.valid_vertex_id( vert_ok ) then
    sobj.m_level_vertex_id = vert_ok
    sobj:set_position( level.vertex_position( vert_ok ) )
    return vert_ok
  end
end


function off_corpses()
  local pt = profile_timer()
  pt:start()
  meceniy_outfit.is_pleer = false

  -- главный цикл
  local actor_level           = level.name()
  local dead_monster_on_level = {}
  dsh_alife.iterate_items(
    function( obj )
      local obj_level = object_level_name( obj )
      local obj_name  = obj:name()
      local obj_sect  = obj:section_name()

      if always_remove[ obj_sect ] then
        table.insert( tabl_monsters_dead, obj )

      elseif obj_sect == "psy_dog_phantom" or obj_sect == "m_phantom" then
        log2(
          "[%s]: found %s on %s: m_game_vertex_id = %s",
          script_name(), obj_name, tostring( obj_level ),
          tostring( obj.m_game_vertex_id )
        )
        table.insert( tabl_monsters_dead, obj )

      elseif not game_graph():valid_vertex_id( obj.m_game_vertex_id ) then
        -- раз это не фантом, значит нужно падать и разбираться, каким
        -- образом у этого объекта оказался такой вертекс.
        ASSERT(
          false,
          "[%s]: invalid vertex_id for %s: m_game_vertex_id = %s",
          script_name(), obj_name, tostring( obj.m_game_vertex_id )
        )

      elseif IsInventoryBox( obj ) then
        if obj_level == actor_level then
          alife():set_switch_online(  obj.id, true  )
          alife():set_switch_offline( obj.id, false )
        end

      -- сталкер
      elseif IsStalker( obj ) then
        if obj_level ~= actor_level and not obj:alive() then
          -- проверка трупа сталкера, если не в исключениях - в
          -- таблицу и бум удалять
          protected_items.unprotect_tabl_corps_keep( obj )
          add_9510_exceptions( obj )
          if
            obj:get_job_online() ~= false and obj:can_be_spawned()
            and ( not protected_items.is_corps_keep_by_story_id( obj ) )
            and ( not sak.can_be_resurrected( obj ) )
            and not protected_items.obj_is_protected(
              obj, "tabl_corps_keep", "exactly"
            )
          then
            if
              obj.m_story_id > 9510 or exceptions_9510[ obj.m_story_id ]
            then
              table.insert( tabl_corpses, obj )
            else
              -- эти трупы пысовские - не удаляются
              table.insert( tabl_corpses_9510, obj )
            end
          end
        end

      -- монстр
      elseif IsMonster( obj ) then
        if obj:alive() then
          if not is_level_vertex_ok( obj, obj_level ) then
            if obj_level == actor_level then
              local vert_ok = fix_level_vertex( obj )
              if vert_ok then
                log2( "[%s]:   fixed vertex: %s", script_name(), vert_ok )
              end
            end
          end
        else
          -- труп
          if obj_level == actor_level then
            dead_monster_on_level[ obj.id ] = obj
          else
            table.insert( tabl_monsters_dead, obj )
          end
        end

        -- оружие и т.п.
      elseif
        (
          obj:get_weapon()
          or isWeaponGrenade( obj )
          or IsBinocular( obj )
          or IsGrenadeLauncher( obj )
          or IsScope( obj )
          or IsSilencer( obj )
          or isOutfit( obj )
          or IsAmmoGrenade( obj )
        )
        and obj_level ~= actor_level
        and obj:name() == ( obj:section_name() .. obj.id )
        and not item_keep( obj )
      then
        table.insert( tabl_weapons, obj )

        -- трупы ворон
      elseif obj_sect == "mutant_crow" then
        table.insert( tabl_monsters_dead, obj )

      elseif string.find( obj_sect, "af_", 1, true ) then
        if not is_level_vertex_ok( obj, obj_level ) then
          table.insert( tabl_monsters_dead, obj )
        end

      elseif
        get_bool( obj_sect, "monster_part", false )
        and not item_keep( obj )
      then
        table.insert( tabl_monsters_dead, obj )
      end
    end,
    65535                       -- находится на земле
  )

  -- зачистка мёртвых монстров
  local cnt = 0
  for _, corps in ipairs( tabl_monsters_dead ) do
    local keep = dsh_alife.iterate_items(
      function( sobj )
        if item_keep( sobj ) then return true end
      end,
      corps.id
    )
    if not keep then
      cnt = cnt + 1
      dsh_alife.release( corps )
    end
  end

  -- удаление мертвых мутантов с пустым инвентарем на текущей локации
  for id, sobj in pairs( dead_monster_on_level ) do
    local has_something = dsh_alife.iterate_items(
      function( sobj ) return true end,
      sobj.id
    )
    if not has_something then
      cnt = cnt + 1
      dsh_alife.release( sobj )
    end
  end

  -- зачистка мёртвых человеков
  for _, corps in ipairs( tabl_corpses ) do
    local keep = dsh_alife.iterate_items(
      function( sobj )
        if item_keep( sobj ) then return true end
      end,
      corps.id
    )
    if not keep then
      cnt = cnt + 1
      dsh_alife.release( corps )
    end
  end

  -- зачистка оружия
  for _, wpn in ipairs( tabl_weapons ) do
    cnt = cnt + 1
    dsh_alife.release( wpn )
  end

  pt:stop()
  log2( "[%s]: %s objects released: %s", script_name(), cnt, pt:time() )
end


local cached_item = {}
function item_keep( item )
  -- проверка на предметы, тела с которыми нужно оставить
  local sect = item:section_name()
  local k
  if item:name() == sect .. item.id then
    k = sect
  else
    k = item:name()
  end
  if cached_item[ k ] == nil then
    if get_bool( sect, "sak_off_corpses.ignore_item", false ) then
      cached_item[ k ] = false
    else
      cached_item[ k ] =
        get_bool( sect, "quest_item", false )
        or get_bool( sect, "watcher_act.bad_item", false )
        or protected_items.obj_is_protected( item, "tabl_items_keep", "like" )
        or ( isWeapon( item ) and protected_items.is_unique_wpn_keep( sect ) )
        or protected_items.obj_is_protected( item, "tabl_wpn_keep", "like" )
        or false
    end
  end
  return cached_item[ k ]
end


function add_9510_exceptions( sobj )
  local by_info = exceptions_9510_info[ sobj.m_story_id ]
  if by_info and sak.has_all_info( by_info ) then
    exceptions_9510[ sobj.m_story_id ] = true
  end
end
